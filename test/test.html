<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Tests</title>
<link rel="stylesheet" href="../node_modules/qunitjs/qunit/qunit.css">
<script src="../node_modules/qunitjs/qunit/qunit.js"></script>
<script src="../node_modules/document-register-element/build/document-register-element.js"></script>
<script src="../dist/html-import.min.js"></script>
</head>
<body>
<div id="qunit"></div>
<div id="qunit-fixture"></div>


<div class="fixture import-everything">
  <html-import src="content.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import everything from a file", function (assert) {
    const fixture = document.querySelector(".fixture.import-everything");
    const expected = `<p id="lorem">Lorem</p><p id="ipsum">Ipsum</p>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.endsWith(expected), "The content gets added");
  });
}, 1000);
</script>


<div class="fixture import-lorem">
  <html-import src="content.html#lorem"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import only a single element from a file", function (assert) {
    const fixture = document.querySelector(".fixture.import-lorem");
    const expected = `<p id="lorem">Lorem</p>`;
    const unexpected = `<p id="ipsum">Ipsum</p>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.includes(expected), "Lorem gets added");
    assert.notOk(actual.includes(unexpected), "Ipsum does not get added");
  });
}, 1000);
</script>


<div class="fixture import-ipsum">
  <html-import src="content.html#ipsum"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import only another single element from a file", function (assert) {
    const fixture = document.querySelector(".fixture.import-ipsum");
    const expected = `<p id="ipsum">Ipsum</p>`;
    const unexpected = `<p id="lorem">Lorem</p>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.includes(expected), "Lorem does not get added");
    assert.notOk(actual.includes(unexpected), "Ipsum gets added");
  });
}, 1000);
</script>


<div class="fixture import-js-api">
  <html-import src="content.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import element should have a js api where properties reflect attributes", function (assert) {
    const subject = document.querySelector(".fixture.import-js-api html-import");
    assert.equal(subject.src, subject.getAttribute("src"), "The 'src' attribute is reflected");
    assert.equal(subject.as, subject.getAttribute("as"), "The 'as' attribute is reflected");
    assert.ok(subject.ready, "The 'ready' property is present");
  });
}, 1000);
</script>


<div class="fixture import-nested">
  <html-import src="b.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import file b which imports file a", function (assert) {
    const fixture = document.querySelector(".fixture.import-nested");
    const expected1 = `<p>File B, importing file C</p>`;
    const expected2 = `<p>File C, importing the "lorem" paragraph from content.html</p>`
    const expected3 = `<p id="lorem">Lorem</p>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.includes(expected1), "File B is imported");
    assert.ok(actual.includes(expected2), "File C is imported by file B");
    assert.ok(actual.includes(expected3), "Lorem paragraph is imported by file C");
  });
}, 1000);
</script>


<div class="fixture import-template-content">
  <html-import src="template.html#TheTemplate"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import a <template> element's content if referenced by ID", function (assert) {
    const fixture = document.querySelector(".fixture.import-template-content");
    const expected1   = `<p>Imported and unwrapped from a template, paragraph A</p>`;
    const expected2   = `<p>Imported and unwrapped from a template, paragraph B</p>`
    const unexpected1 = `<template`;
    const unexpected2 = `</template>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.includes(expected1), "Content from the template is imported");
    assert.ok(actual.includes(expected2), "More content from the template is imported");
    assert.notOk(actual.includes(unexpected1), "The template itself does not get imported");
    assert.notOk(actual.includes(unexpected2), "The template itself does not get imported");
  });
}, 1000);
</script>


<div class="fixture import-template-inside">
  <html-import src="insidetemplate.html#SomethingInsideTheTemplate"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Import a element that's inside a <template> element in the imported content", function (assert) {
    const fixture = document.querySelector(".fixture.import-template-inside");
    const expected1   = `<p id="SomethingInsideTheTemplate">This lone paragraph should be imported</p>`
    const unexpected1 = `<template`;
    const unexpected2 = `</template>`;
    const unexpected3 = `<p>This should not be imported</p>`;
    const actual = fixture.innerHTML.trim();
    assert.ok(actual.includes(expected1), "The target content from the template is imported");
    assert.notOk(actual.includes(unexpected1), "The template itself does not get imported");
    assert.notOk(actual.includes(unexpected2), "The template itself does not get imported");
    assert.notOk(actual.includes(unexpected3), "Only the target content gets imported");
  });
}, 1000);
</script>


<div class="fixture import-script">
  <html-import src="script.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Scripts in imported files should run", function (assert) {
    const fixture = document.querySelector(".fixture.import-script");
    const subject = fixture.querySelector(".scripting");
    assert.equal(subject.style.color, "green", "The script has run");
  });
}, 1000);
</script>


<div class="fixture import-script-external">
  <html-import src="external-script.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("External scripts in imported files should run", function (assert) {
    const fixture = document.querySelector(".fixture.import-script-external");
    const subject = fixture.querySelector(".scripting");
    assert.equal(subject.style.color, "blue", "The script has run");
  });
}, 1000);
</script>


<div class="fixture import-script-import-script">
  <html-import src="import-script.html"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Scripts in imported files in imported files should run", function (assert) {
    const fixture  = document.querySelector(".fixture.import-script-import-script");
    const subject1 = fixture.querySelector(".scripting.red");
    const subject2 = fixture.querySelector(".scripting.green");
    assert.equal(subject1.style.color, "red", "The imported script has run");
    assert.equal(subject2.style.color, "green", "The script in the imported imported file has run");
  });
}, 1000);
</script>


<div class="fixture import-promises">
  <html-import src="a.html"></html-import>
</div>
<script>
QUnit.test("Promise resolution for nested imports", function (assert) {
  const done = assert.async();
  const fixture = document.querySelector(".fixture.import-promises");
  const subject = fixture.querySelector("html-import");
  subject.ready.then(function(){
    const paragraphs = fixture.querySelectorAll("p");
    assert.equal(paragraphs.length, 4, "All paragraphs are imported at this point");
    done();
  });
});
</script>


<div class="fixture import-promises-reject-src-missing">
  <html-import></html-import>
</div>
<script>
QUnit.test("Promises for import elements that don't have a src should be rejected, the element should do nothing", function (assert) {
  const done = assert.async();
  const fixture  = document.querySelector(".fixture.import-promises-reject-src-missing");
  const subject  = fixture.querySelector("html-import");
  const expected = `<html-import></html-import>`;
  const actual   = fixture.innerHTML.trim();
  subject.ready
    .then( () => "resolved", () => "rejected")
    .then( (result) => {
      assert.ok(result, "rejected", "The promise was rejected");
      assert.equal(actual, expected, "Nothing was imported");
      done();
    });
});
</script>


<div class="fixture import-promises-reject-src-empty">
  <html-import src=""></html-import>
</div>
<script>
QUnit.test("Promises for import elements that are not importing anything should be rejected", function (assert) {
  const done = assert.async();
  const fixture  = document.querySelector(".fixture.import-promises-reject-src-empty");
  const subject  = fixture.querySelector("html-import");
  const expected = `<html-import src=""></html-import>`;
  const actual   = fixture.innerHTML.trim();
  subject.ready
    .then( () => "resolved", () => "rejected")
    .then( (result) => {
      assert.ok(result, "rejected", "The promise was rejected");
      assert.equal(actual, expected, "Nothing was imported");
      done();
    });
});
</script>


<div class="fixture import-as-attribute">
  <html-import src="content.html#lorem" as="ipsum"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Importing and renaming content using the 'as' attribute", function (assert) {
    const fixture  = document.querySelector(".fixture.import-as-attribute");
    const subject  = fixture.querySelector("html-import");
    const expected = `<p id="ipsum">Lorem</p>`;
    const actual   = fixture.innerHTML.trim();
    assert.ok(actual.endsWith(expected), "The content gets added and renamed");
  });
}, 1000);
</script>


<div class="fixture as-attribute-but-no-id">
  <html-import src="content.html" as="foo"></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Importing content and using the 'as' attribute when there's no ID involved", function (assert) {
    const fixture  = document.querySelector(".fixture.as-attribute-but-no-id");
    const subject  = fixture.querySelector("html-import");
    const expected = `<p id="lorem">Lorem</p><p id="ipsum">Ipsum</p>`;
    const actual   = fixture.innerHTML.trim();
    assert.ok(actual.endsWith(expected), "The content gets added and the as attribute is ignored");
  });
}, 1000);
</script>


<div class="fixture import-as-attribute-empty">
  <html-import src="content.html#lorem" as=""></html-import>
</div>
<script>
setTimeout( () => {
  QUnit.test("Importing content and erasing the id using the 'as' attribute", function (assert) {
    const fixture  = document.querySelector(".fixture.import-as-attribute-empty");
    const subject  = fixture.querySelector("html-import");
    const expected = `<p>Lorem</p>`;
    const actual   = fixture.innerHTML.trim();
    assert.ok(actual.endsWith(expected), "The content gets added and the id is erased");
  });
}, 1000);
</script>


<div class="fixture import-as-attribute-template">
  <html-import src="template.html#TheTemplate" as="SomethingElse"></html-import>
</div>
<script>
QUnit.test("Ignore the as attribute when importing templates", function (assert) {
  const done = assert.async();
  const fixture  = document.querySelector(".fixture.import-as-attribute-template");
  const subject  = fixture.querySelector("html-import");
  const minimum  = `<html-import src="template.html#TheTemplate" as="SomethingElse"></html-import>`;
  const actual   = fixture.innerHTML.trim();
  subject.ready
    .then( () => "resolved", () => "rejected")
    .then( (result) => {
      assert.ok(result, "resolved", "The promise was resolved");
      assert.notEqual(actual, minimum, "Stuff was imported");
      done();
    });
});
</script>


</body>
</html>